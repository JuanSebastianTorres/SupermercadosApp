{% extends 'layout.html' %}
{% block content %}
<h2>Registro de Ventas</h2>

<form id="formVenta" method="POST" action="{{ url_for('ventas.nueva_venta') }}">
  <!-- Selección del cliente -->
  <label>Cliente:</label>
  <select name="idCliente" id="idCliente" required>
    <option value="" disabled selected>Seleccione un cliente</option>
    {% for c in clientes %}
      <option value="{{ c.idCliente }}">{{ c.nombre }} {{ c.apellido }}</option>
    {% endfor %}
  </select>

  <br><br>

  <!-- Selección del canal -->
  <label>Canal de Venta:</label>
  <select name="canal" id="canal" required>
    <option value="POS">Física (POS)</option>
    <option value="ONLINE">Online</option>
  </select>

  <hr>

  <!-- Selección de producto -->
  <label>Producto:</label>
  <select id="productoSelect">
    {% for p in productos %}
      <option value="{{ p.idProducto }}" data-precio="{{ p.precio }}">
        {{ p.nombre }} (${{ p.precio }})
      </option>
    {% endfor %}
  </select>

  <input type="number" id="cantidadInput" min="1" placeholder="Cantidad" required>
  <button type="button" id="agregarProducto">Agregar al carrito</button>

  <hr>

  <!-- Campo oculto con los productos -->
  <input type="hidden" name="detalle_json" id="detalle_json">

  <!-- BOTONES PRINCIPALES -->
  <div style="text-align:center; margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
    <button type="submit" style="background-color:#004080; color:white; padding:8px 20px; border-radius:6px; border:none;">
      Registrar Venta
    </button>
    <a href="{{ url_for('clientes.listar_clientes') }}" 
       class="btn-nuevo" 
       style="background-color:#6b7280; color:white; padding:8px 20px; border-radius:6px; text-decoration:none;">
       + Nuevo Cliente
    </a>
  </div>
</form>

<hr>

<!-- TABLA DE CARRITO (ABAJO) -->
<h3>Carrito de Compra</h3>
<table id="tablaCarrito" border="1" cellpadding="5" style="width:100%; background:#fafafa;">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Precio</th>
      <th>Cantidad</th>
      <th>Subtotal</th>
      <th>Acción</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3 style="text-align:right;">Total: $<span id="totalVenta">0</span></h3>

<script>
const carrito = [];
const tabla = document.querySelector("#tablaCarrito tbody");
const totalVenta = document.getElementById("totalVenta");
const inputDetalle = document.getElementById("detalle_json");

// Agregar producto al carrito
document.getElementById("agregarProducto").addEventListener("click", () => {
  const select = document.getElementById("productoSelect");
  const id = select.value;
  const nombre = select.options[select.selectedIndex].text.split(" ($")[0];
  const precio = parseInt(select.options[select.selectedIndex].dataset.precio);
  const cantidad = parseInt(document.getElementById("cantidadInput").value);

  if (!cantidad || cantidad <= 0) {
    alert("Ingrese una cantidad válida.");
    return;
  }

  const existente = carrito.find(p => p.id === id);
  if (existente) {
    existente.cantidad += cantidad;
    existente.subtotal = existente.cantidad * precio;
  } else {
    carrito.push({ id, nombre, precio, cantidad, subtotal: cantidad * precio });
  }

  actualizarTabla();
});

// Actualizar tabla
function actualizarTabla() {
  tabla.innerHTML = "";
  let total = 0;
  carrito.forEach((p, i) => {
    total += p.subtotal;
    tabla.innerHTML += `
      <tr>
        <td>${p.nombre}</td>
        <td>$${p.precio}</td>
        <td>${p.cantidad}</td>
        <td>$${p.subtotal}</td>
        <td><button type="button" onclick="eliminarProducto(${i})">❌</button></td>
      </tr>`;
  });
  totalVenta.textContent = total;
  inputDetalle.value = JSON.stringify(carrito);
}

function eliminarProducto(i) {
  carrito.splice(i, 1);
  actualizarTabla();
}
</script>
{% endblock %}

