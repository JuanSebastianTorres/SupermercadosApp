{% extends 'layout.html' %}
{% block content %}
<h2>Gesti√≥n de Productos</h2>

<form id="formProducto" method="post" action="{{ url_for('productos.agregar_producto') }}">
  <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
    <div>
      <label>Referencia:</label>
      <input list="referencias" id="referencia" name="referencia" placeholder="Escribe o selecciona..." required>
      <datalist id="referencias"></datalist>
    </div>

    <div>
      <label>Nombre:</label>
      <input id="nombre" name="nombre" readonly>
    </div>

    <div>
      <label>Descripci√≥n:</label>
      <input id="descripcion" name="descripcion" readonly>
    </div>

    <div>
      <label>Precio:</label>
      <input id="precio" name="precio" type="number" readonly>
    </div>

    <div>
      <label>Cantidad:</label>
      <input id="cantidad" name="cantidad" type="number" min="1" required>
    </div>

    <button type="submit">Agregar al stock</button>
    <button type="button" id="nuevoBtn">Nuevo producto</button>
  </div>
</form>

<hr>

<table border="1" cellpadding="5">
  <tr><th>ID</th><th>Referencia</th><th>Nombre</th><th>Descripci√≥n</th><th>Precio</th><th>Stock</th></tr>
  {% for p in productos %}
    <tr>
      <td>{{ p.idProducto }}</td>
      <td>{{ p.referencia }}</td>
      <td>{{ p.nombre }}</td>
      <td>{{ p.descripcion }}</td>
      <td>${{ p.precio }}</td>
      <td>{{ p.stock }}</td>
    </tr>
  {% endfor %}
</table>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const referencias = document.getElementById("referencias");
  const refInput = document.getElementById("referencia");
  const nombre = document.getElementById("nombre");
  const descripcion = document.getElementById("descripcion");
  const precio = document.getElementById("precio");
  const nuevoBtn = document.getElementById("nuevoBtn");

  let productos = [];
  try {
    const res = await fetch("/api/productos");
    productos = await res.json();

    // Ahora muestra las referencias en la lista desplegable
    productos.forEach(p => {
      const option = document.createElement("option");
      option.value = p.referencia;
      referencias.appendChild(option);
    });
  } catch (err) {
    console.error("Error cargando productos:", err);
  }

  refInput.addEventListener("change", () => {
    const producto = productos.find(p => p.referencia === refInput.value);
    if (producto) {
      nombre.value = producto.nombre;
      descripcion.value = producto.descripcion;
      precio.value = producto.precio;
      nombre.setAttribute("readonly", true);
      descripcion.setAttribute("readonly", true);
      precio.setAttribute("readonly", true);
    } else {
      nombre.value = "";
      descripcion.value = "";
      precio.value = "";
    }
  });

  // üîπ Modo nuevo producto
  nuevoBtn.addEventListener("click", () => {
    refInput.value = "";
    nombre.value = "";
    descripcion.value = "";
    precio.value = "";
    nombre.removeAttribute("readonly");
    descripcion.removeAttribute("readonly");
    precio.removeAttribute("readonly");
    alert("Modo: Nuevo producto habilitado.");
  });
});
</script>
{% endblock %}



